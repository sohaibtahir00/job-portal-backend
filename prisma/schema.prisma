// This is your Prisma schema file for Job Portal
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  ADMIN
  EMPLOYER
  CANDIDATE
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum JobType {
  FULL_TIME
  PART_TIME
  CONTRACT
  INTERNSHIP
  TEMPORARY
}

enum JobStatus {
  DRAFT
  ACTIVE
  PAUSED
  FILLED
  CLOSED
  EXPIRED
}

enum ExperienceLevel {
  ENTRY_LEVEL
  MID_LEVEL
  SENIOR_LEVEL
  EXECUTIVE
}

enum ApplicationStatus {
  PENDING
  REVIEWED
  SHORTLISTED
  INTERVIEW_SCHEDULED
  INTERVIEWED
  OFFERED
  REJECTED
  WITHDRAWN
  ACCEPTED
}

enum TestStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  EXPIRED
}

enum PlacementStatus {
  PENDING
  ACTIVE
  CONFIRMED
  COMPLETED
  CANCELLED
  REPLACEMENT_REQUESTED
  SEEKING_REPLACEMENT
  REPLACED
}

enum PaymentStatus {
  PENDING
  UPFRONT_PAID
  FULLY_PAID
  FAILED
}

enum InvoiceStatus {
  DRAFT
  SENT
  VIEWED
  PAID
  OVERDUE
  CANCELLED
}

enum InvoiceType {
  UPFRONT_PAYMENT
  REMAINING_PAYMENT
  FULL_PAYMENT
  REFUND
}

enum MessageStatus {
  SENT
  DELIVERED
  READ
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  SENT
  FAILED
}

enum ReferralStatus {
  PENDING
  SUCCESSFUL
  EXPIRED
}

enum BlogPostStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum ClaimStatus {
  UNCLAIMED   // Not claimed by admin
  CLAIMED     // Actively being worked on by admin
  CONVERTED   // Successfully converted to placement
  RELEASED    // Released back to pool (admin stopped working on it)
}

enum ApprovalStatus {
  PENDING     // Awaiting admin approval
  APPROVED    // Approved by admin
  REJECTED    // Rejected by admin
}

enum VerificationStatus {
  UNVERIFIED  // Not yet verified
  PENDING     // Verification in progress
  VERIFIED    // Verified by admin
  REJECTED    // Verification rejected
}

enum CandidateResponse {
  PENDING
  ACCEPTED
  DECLINED
  QUESTIONS
}

enum IntroductionStatus {
  PROFILE_VIEWED
  INTRO_REQUESTED
  CANDIDATE_DECLINED
  INTRODUCED
  INTERVIEWING
  OFFER_EXTENDED
  HIRED
  CLOSED_NO_HIRE
  EXPIRED
}

// Models
model User {
  id            String     @id @default(cuid())
  email         String     @unique
  password      String
  name          String
  role          UserRole   @default(CANDIDATE)
  status        UserStatus @default(ACTIVE)
  isActive            Boolean    @default(true)
  emailVerified       DateTime?
  image               String?
  onboardingCompleted Boolean    @default(false)
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  // Settings
  emailNotifications      Boolean @default(true)
  profileVisibility       Boolean @default(true)
  allowRecruiterContact   Boolean @default(true)

  // Notification preferences
  notifyNewApplications   Boolean @default(true)
  notifyInterviewReminders Boolean @default(true)
  notifyMessages          Boolean @default(true)
  notifyPlacementUpdates  Boolean @default(true)
  notifyJobAlerts         Boolean @default(true)
  notifyApplicationUpdates Boolean @default(true)
  notifyWeeklyDigest      Boolean @default(false)
  notifyMarketingEmails   Boolean @default(false)

  // Relations
  candidate                Candidate?
  employer                 Employer?
  sentMessages             Message[]                 @relation("SentMessages")
  receivedMessages         Message[]                 @relation("ReceivedMessages")
  referrals                Referral[]                @relation("UserReferrals")
  referredBy               Referral[]                @relation("ReferredUsers")
  blogPosts                BlogPost[]
  notifications            Notification[]
  passwordResetTokens      PasswordResetToken[]
  emailVerificationTokens  EmailVerificationToken[]

  @@index([email])
  @@index([role])
  @@index([status])
}

model Candidate {
  id               String   @id @default(cuid())
  userId           String   @unique
  phone            String?
  photo            String? // URL to profile photo
  resume           String? // URL to resume file
  portfolio        String? // URL to portfolio
  personalWebsite  String? // Personal website URL
  linkedIn         String?
  github           String?
  bio              String?  @db.Text
  skills           String[] // Array of skills
  currentRole      String? // Current job title (e.g., "Machine Learning Engineer")
  experience       Int? // Years of experience
  education        String?  @db.Text // TODO: DEPRECATED - Remove in future migration. Use Education model instead.
  location         String?
  preferredJobType JobType?
  expectedSalary   Int?
  availability     Boolean  @default(true)

  // Privacy settings
  showEmail        Boolean  @default(false) // Show email on public profile
  showPhone        Boolean  @default(false) // Show phone on public profile

  // Enhanced job preferences
  desiredRoles          String[]  @default([])
  nicheCategory         String? // AI_ML, HEALTHCARE_IT, FINTECH, CYBERSECURITY
  remotePreference      String? // REMOTE, HYBRID, ONSITE
  startDateAvailability DateTime?
  openToContract        Boolean   @default(false)
  willingToRelocate     Boolean   @default(false)

  // Skills testing fields
  hasTakenTest     Boolean   @default(false)
  testScore        Float? // Overall test score (0-100)
  testPercentile   Float? // Percentile rank (0-100)
  testTier         String? // ELITE, ADVANCED, INTERMEDIATE, BEGINNER
  lastTestDate     DateTime? // When last test was taken
  testInviteToken  String?   @unique // Unique token for test invitation link
  testInviteSentAt DateTime? // When test invitation was sent

  // Referral fields
  referralCode     String? @unique // Unique referral code for this candidate
  referredBy       String? // Email of referrer (if referred by someone)
  referralEarnings Int     @default(0) // Total earnings from referrals in cents

  // Admin verification fields
  verificationStatus  VerificationStatus @default(UNVERIFIED)
  verifiedAt          DateTime?
  verifiedBy          String? // Admin user ID who verified
  verificationNotes   String?   @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  applications      Application[]
  testResults       TestResult[]
  placements        Placement[]
  savedJobs         SavedJob[]
  workExperiences   WorkExperience[]
  educationEntries  Education[]
  skillsAssessments SkillsAssessment[]
  profileViews      ProfileView[]
  receivedOffers    Offer[]            @relation("CandidateOffers")
  introductions     CandidateIntroduction[]

  @@index([userId])
  @@index([availability])
  @@index([location])
  @@index([testTier])
  @@index([testInviteToken])
  @@index([referralCode])
  @@index([referredBy])
  @@index([verificationStatus])
}

model Employer {
  id               String  @id @default(cuid())
  userId           String  @unique
  companyName      String
  slug             String? @unique // URL-friendly company identifier
  companyLogo      String?
  companyWebsite   String?
  companySize      String?
  industry         String?
  description      String? @db.Text
  location         String?
  phone            String?
  verified         Boolean @default(false)
  stripeCustomerId String? @unique // Stripe customer ID
  totalSpent       Int     @default(0) // Total amount spent on placements in cents

  // Admin approval workflow
  approvalStatus    ApprovalStatus @default(APPROVED) // Default APPROVED to not break existing employers
  approvedAt        DateTime?
  approvedBy        String? // Admin user ID who approved
  rejectionReason   String?   @db.Text
  rejectedAt        DateTime?

  // Job claiming tracking
  claimedJobsCount Int       @default(0)
  lastClaimDate    DateTime?
  companyDomain    String? // Company email domain for matching (e.g., "acme.com")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user                User                         @relation(fields: [userId], references: [id], onDelete: Cascade)
  jobs                Job[]
  emailCampaigns      EmailCampaign[]
  placements          Placement[]
  profileViews        ProfileView[]
  madeOffers          Offer[]                      @relation("EmployerOffers")
  teamMembers         TeamMember[]
  videoIntegration    VideoIntegration?            // Video conferencing integration
  interviewTemplates  InterviewTemplate[]          // Custom interview templates
  googleCalendar      GoogleCalendarIntegration?   // Google Calendar integration
  interviewReviews    InterviewReview[]
  serviceAgreement         ServiceAgreement?
  jobClaimAcknowledgments  JobClaimAcknowledgment[]
  candidateIntroductions   CandidateIntroduction[]

  @@index([userId])
  @@index([verified])
  @@index([industry])
  @@index([stripeCustomerId])
  @@index([companyDomain])
  @@index([slug])
  @@index([approvalStatus])
}

model Job {
  id               String          @id @default(cuid())
  employerId       String
  title            String
  description      String          @db.Text
  requirements     String          @db.Text
  responsibilities String          @db.Text
  type             JobType
  status           JobStatus       @default(DRAFT)
  location         String
  remote           Boolean         @default(false)
  salaryMin        Int?
  salaryMax        Int?
  experienceLevel  ExperienceLevel
  skills           String[] // Required skills
  niceToHaveSkills String[]        @default([]) // Nice-to-have skills
  techStack        String[]        @default([]) // Tech stack required
  benefits         String?         @db.Text
  deadline         DateTime?
  slots            Int             @default(1)
  views            Int             @default(0)

  // New fields for comprehensive job posting
  nicheCategory       String? // AI/ML, Healthcare IT, Fintech, Cybersecurity
  remoteType          String? // REMOTE, HYBRID, ONSITE
  keyResponsibilities String[] @default([]) // Bullet points for responsibilities
  equityOffered       Boolean  @default(false)
  isCompetitive       Boolean  @default(false) // Competitive salary (no specific range disclosed)
  specificBenefits    String[] @default([]) // Health, Dental, 401k, etc.

  // Skills Assessment Requirements (CRITICAL NEW FEATURE)
  requiresAssessment        Boolean @default(false)
  minSkillsScore            Int? // Minimum score required (0-100)
  requiredTier              String? // Any, Competent+, Proficient+, Advanced+, Expert
  customAssessmentQuestions Json? // Array of custom questions
  isExclusive               Boolean @default(false) // Only for skills-verified candidates

  // Interview Process
  numberOfInterviewRounds Int? // Number of interview rounds
  interviewProcess        String?   @db.Text // Description of interview process
  hiringTimeline          String? // Estimate like "2-4 weeks"
  startDateNeeded         DateTime? // When they need someone to start

  // Application Settings
  maxApplicants      Int? // Maximum number of applicants
  screeningQuestions Json? // Array of screening questions for applicants

  // Job claiming fields
  isClaimed Boolean   @default(false)
  claimedAt DateTime?
  claimedBy String? // Employer ID who claimed this job

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  employer        Employer         @relation(fields: [employerId], references: [id], onDelete: Cascade)
  applications    Application[]
  placements      Placement[]
  savedBy         SavedJob[]
  shares          JobShare[]
  profileViews    ProfileView[]
  offers          Offer[]          @relation("JobOffers")
  interviewRounds InterviewRound[]
  claimAcknowledgments JobClaimAcknowledgment[]
  introductions        CandidateIntroduction[]

  @@index([employerId])
  @@index([status])
  @@index([type])
  @@index([location])
  @@index([experienceLevel])
  @@index([createdAt])
  @@index([isClaimed])
  @@index([nicheCategory])
  @@index([requiresAssessment])
}

model Application {
  id              String            @id @default(cuid())
  jobId           String
  candidateId     String
  coverLetter     String?           @db.Text
  availability    String? // Candidate's availability (e.g., "Immediate", "2 weeks notice")
  hearAboutUs     String? // How did candidate hear about us
  status          ApplicationStatus @default(PENDING)
  appliedAt       DateTime          @default(now())
  reviewedAt      DateTime?
  notes           String?           @db.Text
  rejectionReason String?           @db.Text // Reason for rejection (if rejected)
  rejectedBy      String? // User ID of employer who rejected
  rejectedAt      DateTime? // When the application was rejected
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  // Admin claiming fields - for tracking candidates admin is working on
  claimedAt       DateTime? // When the application was claimed by admin
  claimedBy       String? // Admin user ID who claimed this application
  claimStatus     ClaimStatus @default(UNCLAIMED)
  claimNotes      String?     @db.Text // Admin notes about the claimed candidate

  // Relations
  job         Job          @relation(fields: [jobId], references: [id], onDelete: Cascade)
  candidate   Candidate    @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  testResults TestResult[]
  interviews  Interview[]
  offer       Offer? // One-to-one relation with Offer

  @@unique([jobId, candidateId]) // One application per job per candidate
  @@index([jobId])
  @@index([candidateId])
  @@index([status])
  @@index([appliedAt])
  @@index([rejectedBy])
  @@index([claimStatus])
  @@index([claimedBy])
}

model TestResult {
  id            String     @id @default(cuid())
  applicationId String
  candidateId   String
  testName      String
  testType      String // e.g., "Technical", "Aptitude", "Personality"
  score         Int
  maxScore      Int
  status        TestStatus @default(NOT_STARTED)
  startedAt     DateTime?
  completedAt   DateTime?
  feedback      String?    @db.Text
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  // Relations
  application Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  candidate   Candidate   @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  @@index([applicationId])
  @@index([candidateId])
  @@index([status])
}

model Placement {
  id          String          @id @default(cuid())
  candidateId String
  employerId  String? // Employer who hired the candidate
  jobId       String? // Job this placement is for
  jobTitle    String
  companyName String
  startDate   DateTime
  endDate     DateTime?
  salary      Int?
  status      PlacementStatus @default(PENDING)
  notes       String?         @db.Text

  // Payment fields
  paymentStatus          PaymentStatus @default(PENDING)
  placementFee           Int? // Total placement fee in cents
  feePercentage          Float         @default(18) // Fee percentage (default 18%)
  upfrontPercentage      Float         @default(50) // Upfront payment percentage (customizable)
  remainingPercentage    Float         @default(50) // Remaining payment percentage (customizable)
  upfrontAmount          Int? // Upfront payment in cents (calculated from upfrontPercentage)
  remainingAmount        Int? // Remaining payment in cents (calculated from remainingPercentage)
  upfrontPaidAt          DateTime? // When upfront payment was completed
  remainingPaidAt        DateTime? // When remaining payment was completed
  upfrontPaymentMethod   String? // Payment method for upfront (bank_transfer, wire, check, stripe)
  remainingPaymentMethod String? // Payment method for remaining
  upfrontTransactionId   String? // Transaction ID for upfront payment
  remainingTransactionId String? // Transaction ID for remaining payment
  stripePaymentIntentId  String? // Stripe Payment Intent ID for upfront
  stripePaymentIntentId2 String? // Stripe Payment Intent ID for remaining

  // Probation period
  probationPeriodDays Int       @default(90) // Probation period in days
  probationEndDate    DateTime? // Calculated: startDate + probationPeriodDays

  // Guarantee period
  guaranteePeriodDays Int       @default(90) // Guarantee period in days
  guaranteeEndDate    DateTime? // Calculated: startDate + guaranteePeriodDays

  // Replacement tracking
  replacementRequested      Boolean   @default(false)
  replacementRequestedAt    DateTime?
  replacementReason         String?   @db.Text
  replacementLastDayWorked  DateTime?
  replacementDaysWorked     Int?
  replacementApproved       Boolean?
  replacementReviewedAt     DateTime?
  replacementReviewedBy     String? // Admin user ID
  replacementNotes          String?   @db.Text

  // Refund tracking
  refundAmount       Int?      @default(0) // In cents
  refundProcessed    Boolean   @default(false)
  refundProcessedAt  DateTime?
  refundStripeId     String? // Stripe refund ID
  refundMethod       String? // stripe_refund, manual, no_refund

  // Replacement link
  replacesPlacementId   String? // If this is a replacement for another placement
  replacedByPlacementId String? // If this placement was replaced by another

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  candidate            Candidate    @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  employer             Employer?    @relation(fields: [employerId], references: [id], onDelete: SetNull)
  job                  Job?         @relation(fields: [jobId], references: [id], onDelete: SetNull)
  replacesPlacement    Placement?   @relation("ReplacementOf", fields: [replacesPlacementId], references: [id], onDelete: SetNull)
  replacedByPlacements Placement[]  @relation("ReplacementOf")
  invoices             Invoice[]

  @@index([candidateId])
  @@index([employerId])
  @@index([jobId])
  @@index([status])
  @@index([paymentStatus])
  @@index([startDate])
  @@index([replacementRequested])
  @@index([replacesPlacementId])
}

model Invoice {
  id          String        @id @default(cuid())
  placementId String
  invoiceType InvoiceType
  status      InvoiceStatus @default(DRAFT)

  // Invoice details
  invoiceNumber String   @unique // e.g., "INV-2025-001234"
  amount        Int // Amount in cents
  dueDate       DateTime
  paidAt        DateTime?
  sentAt        DateTime?
  viewedAt      DateTime?

  // Payment details
  paymentMethod     String? // bank_transfer, wire, check, stripe
  transactionId     String? // External transaction reference
  stripeInvoiceId   String? // Stripe invoice ID if using Stripe
  stripePaymentId   String? // Stripe payment intent ID

  // Invoice content (stored for audit trail)
  recipientEmail String
  recipientName  String
  companyName    String
  subject        String
  htmlContent    String? @db.Text // HTML email content sent
  pdfUrl         String? // URL to PDF invoice (if generated)

  // Metadata
  feePercentage       Float // Fee percentage at time of invoice
  upfrontPercentage   Float // Payment split percentage
  remainingPercentage Float
  notes               String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  placement Placement @relation(fields: [placementId], references: [id], onDelete: Cascade)

  @@index([placementId])
  @@index([status])
  @@index([invoiceType])
  @@index([dueDate])
  @@index([invoiceNumber])
}

model Message {
  id         String        @id @default(cuid())
  senderId   String
  receiverId String
  subject    String?
  content    String        @db.Text
  status     MessageStatus @default(SENT)
  readAt     DateTime?
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt

  // Relations
  sender   User @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiver User @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)

  @@index([senderId])
  @@index([receiverId])
  @@index([status])
  @@index([createdAt])
}

model EmailCampaign {
  id          String         @id @default(cuid())
  employerId  String
  name        String
  subject     String
  content     String         @db.Text
  recipients  String[] // Array of email addresses
  status      CampaignStatus @default(DRAFT)
  scheduledAt DateTime?
  sentAt      DateTime?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  // Relations
  employer Employer @relation(fields: [employerId], references: [id], onDelete: Cascade)

  @@index([employerId])
  @@index([status])
  @@index([scheduledAt])
}

model Referral {
  id             String         @id @default(cuid())
  referrerId     String
  referredUserId String?
  email          String
  name           String?
  phone          String?
  status         ReferralStatus @default(PENDING)
  reward         Int? // Referral reward amount in cents
  payoutStatus   String? // PENDING, PAID, CANCELLED
  paidAt         DateTime? // When reward was paid
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  expiresAt      DateTime?

  // Relations
  referrer     User  @relation("UserReferrals", fields: [referrerId], references: [id], onDelete: Cascade)
  referredUser User? @relation("ReferredUsers", fields: [referredUserId], references: [id], onDelete: SetNull)

  @@index([referrerId])
  @@index([referredUserId])
  @@index([status])
  @@index([email])
  @@index([payoutStatus])
}

model BlogPost {
  id            String         @id @default(cuid())
  authorId      String
  title         String
  slug          String         @unique
  content       String         @db.Text
  excerpt       String?        @db.Text
  featuredImage String?
  tags          String[]
  status        BlogPostStatus @default(DRAFT)
  views         Int            @default(0)
  publishedAt   DateTime?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  // Relations
  author User @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([authorId])
  @@index([slug])
  @@index([status])
  @@index([publishedAt])
  @@index([tags])
}

model SavedJob {
  id          String   @id @default(cuid())
  candidateId String
  jobId       String
  notes       String?  @db.Text // Optional notes from candidate
  savedAt     DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  candidate Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  job       Job       @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@unique([candidateId, jobId]) // One save per job per candidate
  @@index([candidateId])
  @@index([jobId])
  @@index([savedAt])
}

model JobShare {
  id        String   @id @default(cuid())
  jobId     String
  platform  String? // e.g., "linkedin", "twitter", "email"
  sharedBy  String? // User ID who shared (if logged in)
  ipAddress String? // IP address for anonymous shares
  sharedAt  DateTime @default(now())
  createdAt DateTime @default(now())

  // Relations
  job Job @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([jobId])
  @@index([sharedAt])
  @@index([platform])
}

model WorkExperience {
  id          String    @id @default(cuid())
  candidateId String
  companyName String
  jobTitle    String
  startDate   DateTime
  endDate     DateTime?
  isCurrent   Boolean   @default(false)
  description String?   @db.Text
  location    String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  candidate Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  @@index([candidateId])
  @@index([startDate])
}

model Education {
  id             String   @id @default(cuid())
  candidateId    String
  schoolName     String
  degree         String
  fieldOfStudy   String
  graduationYear Int
  gpa            Float?
  description    String?  @db.Text
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  candidate Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  @@index([candidateId])
  @@index([graduationYear])
}

model SkillsAssessment {
  id            String   @id @default(cuid())
  candidateId   String
  score         Int // Overall score (0-100)
  tier          String // Elite, Advanced, Proficient, Intermediate, Beginner
  answers       String   @db.Text // JSON string of answers
  duration      Int // Duration in seconds
  sectionScores String   @db.Text // JSON string of section scores
  completedAt   DateTime
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  candidate Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  @@index([candidateId])
  @@index([score])
  @@index([tier])
  @@index([completedAt])
}

model ProfileView {
  id          String   @id @default(cuid())
  candidateId String
  employerId  String
  viewedAt    DateTime @default(now())
  source      String? // search, application, recommendation, job_post
  jobId       String? // If viewed from a job application

  // Relations
  candidate Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  employer  Employer  @relation(fields: [employerId], references: [id], onDelete: Cascade)
  job       Job?      @relation(fields: [jobId], references: [id], onDelete: SetNull)

  @@index([candidateId])
  @@index([employerId])
  @@index([viewedAt])
  @@index([jobId])
}

enum InterviewStatus {
  PENDING_AVAILABILITY // Employer hasn't set availability yet
  AWAITING_CANDIDATE   // Employer set availability, waiting for candidate to choose
  AWAITING_CONFIRMATION // Candidate chose slots, waiting for employer to confirm
  SCHEDULED            // Interview is confirmed and scheduled
  COMPLETED
  CANCELLED
  RESCHEDULED
}

enum OfferStatus {
  PENDING   // Offer made, waiting for candidate response
  ACCEPTED  // Candidate accepted the offer
  DECLINED  // Candidate declined the offer
  EXPIRED   // Offer expired before candidate responded
  WITHDRAWN // Employer withdrew the offer
}

enum InterviewType {
  PHONE
  VIDEO
  ONSITE
}

model Interview {
  id                String          @id @default(cuid())
  applicationId     String
  candidateId       String
  employerId        String
  scheduledAt       DateTime?       // Optional until confirmed
  duration          Int             // Duration in minutes
  type              InterviewType
  status            InterviewStatus @default(PENDING_AVAILABILITY)
  round             String?         // Interview round name (e.g., "Phone Screen", "Technical Interview")
  roundNumber       Int?            // 1, 2, 3, etc. for tracking progression
  roundName         String?         // Duplicate of round for clarity
  interviewerId     String?         // ID of team member conducting interview
  location          String?         // For onsite interviews
  meetingLink       String?         // For video interviews (manual or auto-generated)
  videoLink         String?         // Auto-generated Zoom/Meet link
  videoPlatform     String?         // "ZOOM", "GOOGLE_MEET", "CUSTOM"
  notes             String?         @db.Text
  feedback          String?         @db.Text
  rescheduledFromId String?         // Track which interview this was rescheduled from
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  // Relations
  application       Application               @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  interviewer       TeamMember?               @relation(fields: [interviewerId], references: [id], onDelete: SetNull)
  availabilitySlots InterviewAvailability[]
  selectedSlots     InterviewSlotSelection[]
  review            InterviewReview?
  rescheduledFrom   Interview?                @relation("RescheduledInterview", fields: [rescheduledFromId], references: [id], onDelete: SetNull)
  rescheduledTo     Interview[]               @relation("RescheduledInterview")

  @@index([applicationId])
  @@index([candidateId])
  @@index([employerId])
  @@index([scheduledAt])
  @@index([status])
  @@index([roundNumber])
  @@index([interviewerId])
  @@index([rescheduledFromId])
}

// Interview Reviews (Internal employer assessments)
model InterviewReview {
  id              String   @id @default(cuid())
  interviewId     String   @unique
  employerId      String

  overallRating   Int      // 1-5
  technicalSkills String?  // "strong" | "weak" | null
  communication   String?  // "strong" | "weak" | null
  cultureFit      String?  // "strong" | "weak" | null
  problemSolving  String?  // "strong" | "weak" | null
  notes           String?  @db.Text

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  interview Interview @relation(fields: [interviewId], references: [id], onDelete: Cascade)
  employer  Employer  @relation(fields: [employerId], references: [id])

  @@index([interviewId])
  @@index([employerId])
}

// Employer's available time slots for interviews
model InterviewAvailability {
  id          String   @id @default(cuid())
  interviewId String
  startTime   DateTime
  endTime     DateTime
  isAvailable Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  interview      Interview                @relation(fields: [interviewId], references: [id], onDelete: Cascade)
  candidateSlots InterviewSlotSelection[]

  @@index([interviewId])
  @@index([startTime])
}

// Candidate's selected time slots from employer's availability
model InterviewSlotSelection {
  id             String   @id @default(cuid())
  interviewId    String
  availabilityId String
  isConfirmed    Boolean  @default(false) // True when employer confirms this slot
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  interview    Interview             @relation(fields: [interviewId], references: [id], onDelete: Cascade)
  availability InterviewAvailability @relation(fields: [availabilityId], references: [id], onDelete: Cascade)

  @@unique([interviewId, availabilityId]) // Candidate can't select same slot twice
  @@index([interviewId])
  @@index([availabilityId])
  @@index([isConfirmed])
}

// Team Members who conduct interviews
model TeamMember {
  id         String      @id @default(cuid())
  employerId String
  name       String
  email      String
  title      String? // e.g., "Engineering Manager", "Senior Engineer"
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt

  // Relations
  employer   Employer    @relation(fields: [employerId], references: [id], onDelete: Cascade)
  interviews Interview[]

  @@index([employerId])
}

// Interview Rounds for structured interview process
model InterviewRound {
  id          String   @id @default(cuid())
  jobId       String
  name        String // e.g., "Phone Screen", "Technical Interview"
  description String? // e.g., "Initial conversation with recruiter"
  duration    Int // in minutes
  order       Int // 1, 2, 3, etc.
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  job Job @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([jobId])
  @@index([order])
}

// Job Offers
model Offer {
  id            String      @id @default(cuid())
  applicationId String      @unique // One offer per application
  jobId         String
  candidateId   String
  employerId    String

  // Offer details
  position      String
  salary        Int // Annual salary in cents
  equity        Float? // Equity percentage (e.g., 0.5 for 0.5%)
  signingBonus  Int? // Signing bonus in cents
  benefits      String[] // Array of benefits (e.g., Health, Dental, 401k)
  startDate     DateTime

  // Offer letter
  offerLetter   String? // URL to offer letter PDF
  customMessage String? @db.Text // Personalized message from employer

  // Status and timing
  status        OfferStatus @default(PENDING)
  expiresAt     DateTime // Offer expiration date
  respondedAt   DateTime? // When candidate accepted/declined

  // Candidate response
  declineReason String? @db.Text // If declined, why?

  // Employer withdrawal
  withdrawnAt    DateTime? // When employer withdrew the offer
  withdrawReason String?   @db.Text // Reason for withdrawal

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  application Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  job         Job         @relation("JobOffers", fields: [jobId], references: [id], onDelete: Cascade)
  candidate   Candidate   @relation("CandidateOffers", fields: [candidateId], references: [id], onDelete: Cascade)
  employer    Employer    @relation("EmployerOffers", fields: [employerId], references: [id], onDelete: Cascade)

  @@index([applicationId])
  @@index([jobId])
  @@index([candidateId])
  @@index([employerId])
  @@index([status])
  @@index([expiresAt])
  @@index([createdAt])
}

// Newsletter Subscriptions
model Newsletter {
  id             String    @id @default(cuid())
  email          String    @unique
  subscribedAt   DateTime  @default(now())
  isActive       Boolean   @default(true)
  unsubscribedAt DateTime?

  @@index([email])
  @@index([subscribedAt])
  @@index([isActive])
}

// Notification Types
enum NotificationType {
  APPLICATION_UPDATE
  MESSAGE_RECEIVED
  INTERVIEW_SCHEDULED
  INTERVIEW_RESCHEDULE_REQUEST
  ASSESSMENT_COMPLETED
  JOB_MATCH
  JOB_STATUS_CHANGE
  PLACEMENT_UPDATE
  SYSTEM_ANNOUNCEMENT
}

// User Notifications
model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  message   String           @db.Text
  link      String?
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@index([type])
}

// Resource Types
enum ResourceType {
  PDF
  VIDEO
  ARTICLE
  TEMPLATE
  GUIDE
  WEBINAR
}

// Resources/Downloads
model Resource {
  id          String       @id @default(cuid())
  title       String
  description String       @db.Text
  type        ResourceType
  fileUrl     String?
  externalUrl String?
  thumbnail   String?
  downloads   Int          @default(0)
  published   Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([type])
  @@index([published])
}

// Marketing Campaigns
model Campaign {
  id          String    @id @default(cuid())
  name        String
  type        String // "CLAIM_JOB", "SKILLS_TEST", "REFERRAL", etc.
  description String?   @db.Text
  startDate   DateTime
  endDate     DateTime?
  impressions Int       @default(0)
  clicks      Int       @default(0)
  conversions Int       @default(0)
  budget      Float?
  spent       Float     @default(0)
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([type])
  @@index([isActive])
  @@index([startDate])
}

// Password Reset Tokens
model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
}

// Email Verification Tokens
model EmailVerificationToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
}

// Video Conferencing Integration
model VideoIntegration {
  id           String    @id @default(cuid())
  employerId   String    @unique
  platform     String // "ZOOM" or "GOOGLE_MEET"
  accessToken  String    @db.Text
  refreshToken String?   @db.Text
  expiresAt    DateTime?
  email        String? // Connected account email
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  employer Employer @relation(fields: [employerId], references: [id], onDelete: Cascade)

  @@index([employerId])
}

// Custom Interview Templates
model InterviewTemplate {
  id         String   @id @default(cuid())
  employerId String
  name       String // e.g., "Standard 3-Round", "Fast-Track"
  isDefault  Boolean  @default(false)
  rounds     Json // Array of {name, duration, description}
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  employer Employer @relation(fields: [employerId], references: [id], onDelete: Cascade)

  @@index([employerId])
  @@index([employerId, isDefault])
}

// Google Calendar Integration
model GoogleCalendarIntegration {
  id            String    @id @default(cuid())
  employerId    String    @unique

  // OAuth Tokens
  accessToken   String    @db.Text
  refreshToken  String    @db.Text
  expiresAt     DateTime

  // Settings
  email         String
  calendarId    String    @default("primary")
  showBusyTimes Boolean   @default(true)
  blockSlots    Boolean   @default(true)

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  employer      Employer  @relation(fields: [employerId], references: [id], onDelete: Cascade)

  @@index([employerId])
  @@map("google_calendar_integrations")
}

// Fee Protection System Models

// Stores signed employer service agreements
model ServiceAgreement {
  id                String   @id @default(cuid())
  employerId        String   @unique

  signedAt          DateTime
  signerName        String
  signerTitle       String
  signerEmail       String
  ipAddress         String
  agreementVersion  String   // "v1.0"
  agreementText     String   @db.Text

  createdAt         DateTime @default(now())

  // Relations
  employer          Employer @relation(fields: [employerId], references: [id], onDelete: Cascade)

  @@index([employerId])
  @@index([signedAt])
}

// Tracks per-job acknowledgments after initial agreement
model JobClaimAcknowledgment {
  id                String   @id @default(cuid())
  employerId        String
  jobId             String

  acknowledgedAt    DateTime

  createdAt         DateTime @default(now())

  // Relations
  employer          Employer @relation(fields: [employerId], references: [id], onDelete: Cascade)
  job               Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@unique([employerId, jobId])
  @@index([employerId])
  @@index([jobId])
}

// Core tracking table for all employer-candidate interactions
model CandidateIntroduction {
  id                   String              @id @default(cuid())

  employerId           String
  candidateId          String
  jobId                String?

  profileViewedAt      DateTime
  introRequestedAt     DateTime?
  candidateRespondedAt DateTime?
  candidateResponse    CandidateResponse?
  introducedAt         DateTime?

  protectionStartsAt   DateTime
  protectionEndsAt     DateTime

  profileViews         Int @default(1)
  resumeDownloads      Int @default(0)

  status               IntroductionStatus @default(PROFILE_VIEWED)

  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  // Relations
  employer             Employer  @relation(fields: [employerId], references: [id], onDelete: Cascade)
  candidate            Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  job                  Job?      @relation(fields: [jobId], references: [id], onDelete: SetNull)

  @@unique([employerId, candidateId])
  @@index([employerId])
  @@index([candidateId])
  @@index([jobId])
  @@index([status])
  @@index([protectionEndsAt])
}
